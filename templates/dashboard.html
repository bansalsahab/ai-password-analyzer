<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Password Vault - Password Analyzer</title>
    <link rel="stylesheet" href="{{ url_for('serve_static', path='css/styles.css') }}">
    <!-- Add Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <header class="dashboard-header">
        <div class="logo">
            <i class="fas fa-shield-alt"></i>
            <span>Password Analyzer</span>
        </div>
        <nav class="dashboard-nav">
            <ul>
                <li><a href="{{ url_for('index') }}" class="nav-link"><i class="fas fa-home"></i> Analyzer</a></li>
                <li><a href="{{ url_for('dashboard') }}" class="nav-link active"><i class="fas fa-vault"></i> Password Vault</a></li>
            </ul>
        </nav>
        <div class="user-menu">
            <span class="username">{{ current_user.username }}</span>
            <a href="{{ url_for('refresh_session') }}" class="refresh-btn">
                <i class="fas fa-sync-alt"></i> Refresh Session
            </a>
            <a href="{{ url_for('logout') }}" class="logout-btn">
                <i class="fas fa-sign-out-alt"></i> Logout
            </a>
        </div>
    </header>

    <main class="dashboard-main">
        <div class="dashboard-sidebar">
            <div class="user-info">
                <div class="user-avatar">
                    <i class="fas fa-user-circle"></i>
                </div>
                <div class="user-details">
                    <h3>{{ current_user.username }}</h3>
                    <p>{{ current_user.email }}</p>
                </div>
            </div>
            
            <ul class="sidebar-menu">
                <li><a href="{{ url_for('dashboard') }}" class="active"><i class="fas fa-key"></i> Saved Passwords</a></li>
                <li><a href="{{ url_for('index') }}"><i class="fas fa-search"></i> Analyze New Password</a></li>
            </ul>
            
            <div class="security-info sidebar-security">
                <h4><i class="fas fa-shield-alt"></i> Zero-Knowledge Encryption</h4>
                <p>Your passwords are encrypted with AES-256 using your master password as the key.</p>
            </div>
        </div>
        
        <div class="dashboard-content">
            <div class="content-header">
                <h1>Saved Passwords</h1>
                <a href="{{ url_for('index') }}" class="btn btn-primary">
                    <i class="fas fa-plus"></i> Analyze New Password
                </a>
            </div>
            
            <!-- Flash Messages -->
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="flash-message {{ category }}">
                            {{ message }}
                            <button class="close-flash"><i class="fas fa-times"></i></button>
                        </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}
            
            <!-- Session status notification -->
            {% if not has_master_password and passwords %}
            <div class="flash-message info">
                <div>
                    <i class="fas fa-info-circle"></i> Your session has expired. 
                    <a href="{{ url_for('refresh_session') }}" style="color: var(--primary-color); text-decoration: underline;">Refresh your session</a> 
                    to view your passwords.
                </div>
                <button class="close-flash"><i class="fas fa-times"></i></button>
            </div>
            {% endif %}
            
            <div class="passwords-container">
                {% if passwords %}
                    <div class="password-grid">
                        {% for password in passwords %}
                            <div class="password-card">
                                <div class="password-header">
                                    <h3 class="password-label">
                                        {% if password.website %}
                                            <i class="fas fa-globe"></i>
                                        {% else %}
                                            <i class="fas fa-key"></i>
                                        {% endif %}
                                        {{ password.label or password.website or 'Unnamed Password' }}
                                    </h3>
                                    <div class="password-score">
                                        <div class="score-badge score-{{ 'high' if password.score >= 80 else 'medium' if password.score >= 50 else 'low' }}">
                                            {{ password.score }}
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="password-metadata">
                                    {% if password.website %}
                                        <div class="meta-item">
                                            <span class="meta-label">Website:</span>
                                            <span class="meta-value">{{ password.website }}</span>
                                        </div>
                                    {% endif %}
                                    
                                    <div class="meta-item">
                                        <span class="meta-label">Entropy:</span>
                                        <span class="meta-value">{{ "%.2f"|format(password.entropy) }}</span>
                                    </div>
                                    
                                    <div class="meta-item">
                                        <span class="meta-label">Added:</span>
                                        <span class="meta-value">{{ password.created_at.split('T')[0] }}</span>
                                    </div>
                                </div>
                                
                                <div class="password-actions">
                                    <button class="btn btn-sm btn-view" onclick="viewPassword({{ password.id }})">
                                        <i class="fas fa-eye"></i> View
                                    </button>
                                    
                                    <button class="btn btn-sm btn-delete" onclick="deletePassword({{ password.id }})">
                                        <i class="fas fa-trash"></i> Delete
                                    </button>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="no-passwords">
                        <div class="empty-state">
                            <i class="fas fa-key empty-icon"></i>
                            <h2>No Saved Passwords</h2>
                            <p>Analyze and save your first password from the analyzer page.</p>
                            <a href="{{ url_for('index') }}" class="btn btn-primary">
                                Analyze Password
                            </a>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
    </main>

    <!-- Password View Modal -->
    <div id="passwordModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">Password Details</h2>
                <span class="close-modal">&times;</span>
            </div>
            <div class="modal-body">
                <div class="password-details">
                    <div class="detail-group" id="password-field-container">
                        <label>Password:</label>
                        <div class="password-field">
                            <input type="password" id="password-field" readonly>
                            <button type="button" id="toggle-password" class="btn-icon">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button type="button" id="copy-password" class="btn-icon">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                        <div id="session-expired-message" style="display:none;" class="session-message">
                            <p>Your session has expired. <a href="{{ url_for('refresh_session') }}" class="refresh-session">Refresh your session</a> to view your passwords.</p>
                        </div>
                    </div>
                    
                    <div class="detail-group">
                        <label>Label:</label>
                        <div id="label-field">-</div>
                    </div>
                    
                    <div class="detail-group">
                        <label>Website:</label>
                        <div id="website-field">-</div>
                    </div>
                    
                    <div class="detail-group">
                        <label>Strength Score:</label>
                        <div class="score-badge-large" id="score-field">0</div>
                    </div>
                    
                    <div class="detail-group">
                        <label>Entropy:</label>
                        <div id="entropy-field">0</div>
                    </div>
                    
                    <div class="detail-group">
                        <label>Date Added:</label>
                        <div id="created-field">-</div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="close-modal-btn" class="btn btn-secondary">Close</button>
                <a href="{{ url_for('refresh_session') }}" id="relogin-btn" class="btn btn-primary" style="display:none;">
                    <i class="fas fa-sync-alt"></i> Refresh Session
                </a>
            </div>
        </div>
    </div>
    
    <!-- Confirmation Modal -->
    <div id="confirmModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Confirm Deletion</h2>
                <span class="close-modal">&times;</span>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this password? This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button id="cancel-delete" class="btn btn-secondary">Cancel</button>
                <button id="confirm-delete" class="btn btn-danger">Delete</button>
            </div>
        </div>
    </div>

    <script>
        // Password viewing functionality
        let currentPasswordId = null;
        
        function viewPassword(id) {
            currentPasswordId = id;
            
            // Clear previous data
            document.getElementById('password-field').value = '';
            document.getElementById('label-field').textContent = '-';
            document.getElementById('website-field').textContent = '-';
            document.getElementById('score-field').textContent = '0';
            document.getElementById('entropy-field').textContent = '0';
            document.getElementById('created-field').textContent = '-';
            document.getElementById('session-expired-message').style.display = 'none';
            document.getElementById('relogin-btn').style.display = 'none';
            
            // Fetch password details
            fetch(`/passwords/${id}`)
                .then(response => response.json())
                .then(data => {
                    // Update modal with password details
                    document.getElementById('modal-title').textContent = data.label || data.website || 'Password Details';
                    
                    // Make sure password field is always shown, even if password data isn't available yet
                    document.getElementById('password-field-container').style.display = 'flex';
                    
                    if (data.password) {
                        // Success - we have the password
                        document.getElementById('password-field').value = data.password;
                        console.log("Password successfully decrypted and displayed");
                    } else {
                        if (data.decryption_failed) {
                            // Session expired - show helpful message
                            document.getElementById('password-field').value = '';
                            document.getElementById('session-expired-message').style.display = 'block';
                            document.getElementById('relogin-btn').style.display = 'inline-flex';
                            
                            // Add a console message for debugging
                            console.log("Session expired or decryption failed: " + (data.error || "No specific error message"));
                            
                            // Show a more visible warning
                            const scoreField = document.getElementById('score-field');
                            scoreField.innerHTML = '<i class="fas fa-lock"></i>';
                            scoreField.className = 'score-badge-large score-low';
                        } else {
                            // No decryption attempted
                            document.getElementById('password-field').value = '••••••••••••';
                        }
                    }
                    
                    document.getElementById('label-field').textContent = data.label || '-';
                    document.getElementById('website-field').textContent = data.website || '-';
                    
                    const scoreField = document.getElementById('score-field');
                    scoreField.textContent = data.score;
                    scoreField.className = 'score-badge-large score-' + 
                        (data.score >= 80 ? 'high' : data.score >= 50 ? 'medium' : 'low');
                    
                    document.getElementById('entropy-field').textContent = data.entropy.toFixed(2);
                    document.getElementById('created-field').textContent = new Date(data.created_at).toLocaleDateString();
                    
                    // Show modal
                    document.getElementById('passwordModal').style.display = 'flex';
                })
                .catch(error => {
                    console.error('Error fetching password details:', error);
                    // Show error notification
                    alert('Error fetching password details. Please try again.');
                });
        }
        
        // Password deletion
        function deletePassword(id) {
            currentPasswordId = id;
            document.getElementById('confirmModal').style.display = 'block';
        }
        
        // Toggle password visibility
        document.getElementById('toggle-password').addEventListener('click', function() {
            const passwordField = document.getElementById('password-field');
            const icon = this.querySelector('i');
            
            if (passwordField.type === 'password') {
                passwordField.type = 'text';
                icon.className = 'fas fa-eye-slash';
            } else {
                passwordField.type = 'password';
                icon.className = 'fas fa-eye';
            }
        });
        
        // Copy password to clipboard
        document.getElementById('copy-password').addEventListener('click', function() {
            const passwordField = document.getElementById('password-field');
            if (passwordField.value && passwordField.value.indexOf('[Session expired') === -1 && 
                passwordField.value !== '••••••••••••') {
                passwordField.select();
                document.execCommand('copy');
                
                // Show feedback
                const icon = this.querySelector('i');
                const originalClass = icon.className;
                icon.className = 'fas fa-check';
                
                setTimeout(function() {
                    icon.className = originalClass;
                }, 1500);
            }
        });
        
        // Confirm deletion
        document.getElementById('confirm-delete').addEventListener('click', function() {
            if (currentPasswordId) {
                fetch(`/passwords/${currentPasswordId}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('confirmModal').style.display = 'none';
                        // Reload page to show updated password list
                        window.location.reload();
                    } else {
                        alert('Failed to delete password. Please try again.');
                    }
                })
                .catch(error => {
                    console.error('Error deleting password:', error);
                    alert('Failed to delete password. Please try again.');
                });
            }
        });
        
        // Cancel deletion
        document.getElementById('cancel-delete').addEventListener('click', function() {
            document.getElementById('confirmModal').style.display = 'none';
        });
        
        // Close modals
        document.querySelectorAll('.close-modal').forEach(button => {
            button.addEventListener('click', function() {
                this.closest('.modal').style.display = 'none';
            });
        });
        
        document.getElementById('close-modal-btn').addEventListener('click', function() {
            document.getElementById('passwordModal').style.display = 'none';
        });
        
        // Close modal if clicking outside
        window.addEventListener('click', function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        });
        
        // Initialize all close flash buttons
        document.addEventListener('DOMContentLoaded', function() {
            // Close flash messages
            document.querySelectorAll('.close-flash').forEach(button => {
                button.addEventListener('click', function() {
                    this.parentElement.remove();
                });
            });
        });
    </script>
</body>
</html> < ! - -   T e s t   c o m m e n t   - - >  
 